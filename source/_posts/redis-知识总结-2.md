---
title: redis 知识总结(2)
date: 2018-11-10 00:51:30
tags:
---

本文主要记录和介绍redis的集群相关的知识。
本人没有项目中的redis集群经验，这里简单记录下文档知识和实验教程链接；
<!--more-->

### redis 同步/主从复制

* 一个主节点可以有个从节点; redis只支持`主-从复制`，不支持`主-主复制`;
* redis 使用异步复制; 同步时主节点查询和写入不受影响，但可以配置同步时不停止执行写请求；从节点清除旧数据恢复为新数据会阻塞，可以配置为用旧数据回复查询讯;
* 从节点首次连接或者失去连接后重新连接后都会开始执行同步机制；同步是原子的，无需用户停留等待;

可以通过直接在命令行中添加`slaveof <masterIP> <masterPort>`或者在配置文件中配置两种方式配置；

同步的过程:

1. slave: 首次或失去连接后重连，发送`sync`命令到主节点;
2. master: 收到`sync`后开始在后台执行快照备份生成最新的rdb文件; 在这期间，也会记录所有新的写请求到一个命令的缓冲区中；
3. master: 后台发送rdb数据文件到从节点；
4. slave: slave在收到rdb文件后，把数据清空恢复为最新的rdb文件数据；
5. master: 开始持续发送缓冲区的写命令；
6. slave: 执行后续收到的命令；
7. salve: 开始执行接收到的请求;

更多细节:

http://www.redis.cn/topics/replication.html

https://blog.csdn.net/Stubborn_Cow/article/details/50442950

### redis 集群

redis 集群是一个提供在多个Redis间节点间共享数据的程序集；而且redis 集群不支持多个keys的命令；
redis 集群通过分区自动分配数据到不同的节点上，并在部分节点失败或不可用时仍能继续处理命令；

集群中的节点负责存储数据、记录集群状态（包括键到正确节点的映射）。集群节点同样能够自动发现其他节点，检测故障节点和推举新的主节点；
集群节点不能代理请求，所以客户端在收到重定向错误(moved 或 ask)时，会将命令重定向到其他节点；

redis 集群只能容忍少数节点不可用；并能推举从节点成为新的主节点；
若没有可用的从节点是，丢失的节点数据将不可用；
但是对于更高的网络分块可用性来说，并不是很好的解决方案；


* 数据分片

redis 集群并没有使用`一致性哈希`,而是引入了哈希槽的概念；
redis 集群中一共有16384个哈希槽,每个key通过CRC16校验后对16384取模来确定所属的哈希槽; 
所有集群中的节点分别负责一部分的哈希槽的数据；通过调整节点负责的哈希槽的数量，很方便地实现节点调整；

官方推荐为每个节点做主从复制，提高可用性；

* 一致性保证

redis无法保证强一致性，因此集群在特定条件下可能丢失写操作；

>
>如果网络分区发生时间较短,那么集群将会继续正常运作,如果分区的时间足够让大部分的一方选举为新的master，那么写入旧master中的数据便丢失了.


* MOVED && ASK

集群中的某节点包含着请求涉及的哈希槽，那么就可以执行；否则将返回一个`MOVED错误;
并包含键对应的哈希槽，和能槽所在的节点连接信息；

```
>GET x
-MOVED 3999 127.0.0.1:xxxx
```

MOVED重定向的含义是目标哈希槽永久地被另一目标节点处理；但在有些时候事情并不是这么这么绝对；
ASK的语义就只是下一个查询发到指定的节点去执行；比如在进行节点间的哈希槽迁移时，就更适合使用ASK。

集群文档和创建教程:

http://www.redis.cn/topics/cluster-spec.html

https://medium.com/commencis/creating-redis-cluster-using-docker-67f65545796d
